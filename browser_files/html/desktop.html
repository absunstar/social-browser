<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Desktop Capture</title>
</head>

<select id="picture" class="image-picker show-html">
</select>
<video autoplay></video>
<p>
    <button>Enable Capture</button>
</p>

<script>
    if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }
</script>
<script src="http://127.0.0.1:60080/js/jquery.js"></script>
<script src="http://127.0.0.1:60080/js/RecordRTC.js"></script>
<script>
    if (window.module) module = window.module;
</script>

<script>
    const {
        desktopCapturer
    } = require('electron');

    let desktopSharing = false;
    let localStream;

    function refresh() {

    }

    function addSource(source) {
        $('select').append($('<option>', {
            value: source.id.replace(":", ""),
            text: source.name
        }));
        $('select option[value="' + source.id.replace(":", "") + '"]').attr('data-img-src', source.thumbnail
            .toDataURL());
        refresh();
    }

    function showSources(callback) {
        callback = callback || function () {};
        desktopCapturer.getSources({
            types: ['window', 'screen']
        }).then(sources => {
            callback(sources);
            for (let source of sources) {
                console.log("Name: " + source.name);
                addSource(source);
            }
        });
    }

    function toggle() {
        if (!desktopSharing) {
            var id = ($('select').val()).replace(/window|screen/g, function (match) {
                return match + ":";
            });
            onAccessApproved(id);
        } else {
            desktopSharing = false;

            if (localStream)
                localStream.getTracks()[0].stop();
            localStream = null;

            document.querySelector('button').innerHTML = "Enable Capture";

            $('select').empty();
            showSources();
            refresh();
        }
    }

    function onAccessApproved(desktop_id) {
        if (!desktop_id) {
            console.log('Desktop Capture access rejected.');
            return;
        }
        desktopSharing = true;
        document.querySelector('button').innerHTML = "Disable Capture";
        console.log("Desktop sharing started.. desktop_id:" + desktop_id);
        navigator.mediaDevices.getUserMedia({
            audio: {
                mandatory: {
                    chromeMediaSource: 'desktop',
                    chromeMediaSourceId: desktop_id
                }
            },
            video: {
                mandatory: {
                    chromeMediaSource: 'desktop',
                    chromeMediaSourceId: desktop_id,
                    minWidth: 1280,
                    maxWidth: 1280,
                    minHeight: 720,
                    maxHeight: 720
                }
            }
        }).then((stream) => handleStream(stream)).catch((e) => getUserMediaError(e));

        function gotStream(stream) {
            localStream = stream;
            document.querySelector('video').src = URL.createObjectURL(stream);
            stream.onended = function () {
                if (desktopSharing) {
                    toggle();
                }
            };
        }

        var _appendBuffer = function (buffer1, buffer2) {
            var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);
            tmp.set(new Uint8Array(buffer1), 0);
            tmp.set(new Uint8Array(buffer2), buffer1.byteLength);
            return tmp.buffer;
        };

        var _sendAjax = function (blob , id) {
           
            var data = new FormData();
            data.append('fileToUpload', blob);

            $.ajax({
                url: "https://127.0.0.1:60043/blob/" + id,
                type: 'POST',
                data: data,
                contentType: false,
                processData: false,
                success: function (data) {
                    alert("boa!");
                },
                error: function () {
                    alert("not so boa!");
                }
            });

        }

        function handleStream(stream) {



            // localStream = stream;
            // const video = document.querySelector('video')
            // video.srcObject = stream
            // video.onloadedmetadata = (e) => video.play()
            var all = null;
            var id = new Date().getTime();
            let recorder = RecordRTC(stream, {
                type: 'video',
                mimeType: 'video/mp4',
                recorderType: MediaStreamRecorder,
                timeSlice: 1000 * 10,
                ondataavailable: function (blob) {
                    _sendAjax(blob , id);
                    // blob.arrayBuffer().then(arr => {
                    //     if (all == null) {
                    //         all = arr
                    //     } else {
                    //         all = _appendBuffer(all, arr)
                    //     }
                    //     console.log(all);
                    // })
                },
            });

            //  let recorder = RecordRTC(stream, {
            //     type: 'audio',
            //     mimeType: 'audio/webm',
            //     recorderType: StereoAudioRecorder,
            // });

            recorder.startRecording();

            setTimeout(() => {
                recorder.stopRecording(function () {

                    $.ajax({
                url: "https://127.0.0.1:60043/blob/" + id,
                type: 'GET' ,
                success: function (data) {
                    $$$.browser.fs.writeFileSync($$$.browser.dir + '/online.mp4',  data);
                },
                error: function () {
                    alert("not so boa!");
                }
            });

                    

                    // let blob = recorder.getBlob();
                    // blob.arrayBuffer().then(arr => {
                    //     console.log(arr);
                    //     $$$.browser.fs.writeFileSync($$$.browser.dir + '/video.mp4', new Buffer(
                    //         arr));

                    // })

                });
            }, 1000 * 5);



        }

        function getUserMediaError(e) {
            console.log('getUserMediaError: ' + JSON.stringify(e, null, '---'));
        }
    }

    $(document).ready(function () {
        showSources((sources) => {
            if (sources.length > 0) {
                onAccessApproved(sources[0].id);
            }
        });
        refresh();
    });

    document.querySelector('button').addEventListener('click', function (e) {
        toggle();
    });
</script>
</body>

</html>