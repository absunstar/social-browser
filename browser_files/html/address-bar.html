<!DOCTYPE html>
<html lang="en" ng-app="myApp">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Address-Bar</title>

    <link rel="stylesheet" href="http://127.0.0.1:60080/css/layout.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/modal.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/form.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/color.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/effect.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/table.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/theme.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/address-bar.css" />
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/social-tabs-custom-theme2.css" />
    <style>
      .btn {
        background: var(--social-current-tab-fill);
        min-width: 200px;
        font-size: 16px;
      }
    </style>
  </head>

  <body ng-controller="mainController">
    <div class="address-input">
      <input id="addressbar_id" ng-change="loadUrls(url)" ng-keydown="addressbarKeydown($event)" ng-model="url" type="text" />
    </div>

    <div class="url-list">
      <ul>
        <li ng-click="goUrl(u.url);$event.stopPropagation()" ng-class="{'selected' : u.selected}" href="{{u.url}}" ng-repeat="u in url_list2  track by $index">
          <a ng-click="goUrl(u.url);$event.stopPropagation()">
            <img ng-src="{{u.logo}}" onerror="this.src='http://127.0.0.1:60080/images/no.png'" />
            <span class="bold green" ng-click="goUrl(u.url);$event.stopPropagation()"> ( {{u.count}} ) </span>
            <span class="blue" ng-click="goUrl(u.url);$event.stopPropagation()"> {{u.url | limitTo:70}} </span>

            <b class="black" ng-click="goUrl(u.url);$event.stopPropagation()"> {{u.title | limitTo:70}} </b>
          </a>
        </li>
      </ul>
      <br />
      <div class="row" ng-show="url_list.length > 0">
        <span class="btn" onclick="event.preventDefault();event.stopPropagation();" ng-click="urls_sort_property = '-count';loadUrls(url)"> Order By Visit Count </span>

        <span class="btn" onclick="event.preventDefault();event.stopPropagation();" ng-click="urls_sort_property = '-last_visit' ;loadUrls(url) "> Order By Last Visit </span>

        <span class="btn" onclick="event.preventDefault();event.stopPropagation();" ng-click="urls_sort_property = 'url';loadUrls(url) "> Order By URL </span>
      </div>
    </div>

    <script src="http://127.0.0.1:60080/js/an.min.js"></script>

    <script>
      if (typeof module === 'object') {
        window.module = module;
        module = undefined;
      }
    </script>

    <script src="http://127.0.0.1:60080/js/client.js"></script>
    <script src="http://127.0.0.1:60080/js/jquery.js"></script>

    <script>
      if (window.module) module = window.module;
    </script>

    <script>
      window.loadurl = function (url) {
        $('#addressbar_id').focus();
        $('#addressbar_id').select();

        if (scope().url0 === url) {
          scope().loadUrls(null, () => {
            setTimeout(() => {
              $('#addressbar_id').focus();
              $('#addressbar_id').select();
            }, 200);
          });
        } else {
          scope().url0 = url;
          scope().loadUrls(url, () => {
            setTimeout(() => {
              $('#addressbar_id').focus();
              $('#addressbar_id').select();
            }, 200);
          });
        }
      };

      const { remote, nativeImage, ipcRenderer } = SOCIALBROWSER.electron;
      var app = angular.module('myApp', []);
      var scope = function () {
        return angular.element(document.querySelector('body')).scope();
      };

      SOCIALBROWSER.on('var.urls', (e, res) => {
        console.log('here');
        scope().url_list = res.data;
      });

      app.controller('mainController', ($scope, $http, $timeout) => {
        $scope.urls_sort_property = '-count';
        $scope.url_list = [];
        $scope.url_list2 = [];
        $scope.url_index = -1;
        $scope.url0 = '';

        $scope.loadUrls = function (url, callback) {
          callback = callback || function () {};

          if (url) {
            $scope.url = url;
          }

          $timeout(() => {
            if ($scope.url_list.length === 0) {
              $scope.url_list = SOCIALBROWSER.var.urls || SOCIALBROWSER.callSync('get_var', { name: 'urls' });
            }

            $scope.url_list2 = [];
            $scope.url_index = -1;

            let sort = $scope.urls_sort_property;
            if (sort === '-count') {
              $scope.url_list.sort((a, b) => {
                return b.count - a.count;
              });
            } else if (sort === '-last_visit') {
              $scope.url_list.sort((a, b) => {
                return b.last_visit - a.last_visit;
              });
            } else if (sort === 'url') {
              $scope.url_list.sort((a, b) => {
                return b.url > a.url;
              });
            }

            let word = $scope.url;

            for (let i = 0; i < $scope.url_list.length; i++) {
              let itm = $scope.url_list[i];

              if ((itm.url && itm.url.like('*' + word + '*')) || (itm.title && itm.title.like('*' + word + '*'))) {
                $scope.url_list2.push(itm);
              }
              if ($scope.url_list2.length > 100) {
                break;
              }
            }
            if ($scope.url_list2.length == 0) {
              $scope.url_list2.push({
                title: word,
                url: word,
              });
            }

            callback();
          }, 200);
        };

        $scope.clearUrlSelection = function () {
          $scope.url_list2.forEach((u) => {
            u.selected = false;
          });
        };

        $scope.selectUrl = function (index) {
          $scope.clearUrlSelection();
          if ($scope.url_list2.length > index) {
            $scope.url_list2[index].selected = true;
            $scope.url = $scope.url_list2[index].url;
            $('.url-list ul').scrollTop($('.url-list ul li')[index].offsetTop - $('.url-list ul').height() + 100);
          }
        };

        $scope.addressbarKeydown = function (e) {
          if (e.which === 13) {
            e.preventDefault();
            e.stopPropagation();
            if (e.ctrlKey === true) {
              $scope.url = $scope.url + '.com';
              $scope.goUrl($scope.url);
            } else {
              $scope.goUrl($scope.url);
            }
            $scope.show_urls = false;
          } else if (e.which == 40 /*down*/) {
            e.preventDefault();
            e.stopPropagation();
            $scope.url_index++;
            if ($scope.url_list2.length <= $scope.url_index) {
              $scope.url_index = 0;
            }
            $scope.selectUrl($scope.url_index);
          } else if (e.which == 38 /*up*/) {
            e.preventDefault();
            e.stopPropagation();
            $scope.url_index--;
            if ($scope.url_index < 0) {
              $scope.url_index = $scope.url_list2.length - 1;
            }
            $scope.selectUrl($scope.url_index);
          } else {
          }
        };

        $scope.bodyKeydown = function (e) {
          $scope.show_urls = false;
        };

        $scope.hi = function () {
          alert('hi');
        };

        $scope.goUrl = function (url) {
          url = url || $scope.url || '';

          if (url.indexOf('://') === -1) {
            if (url.indexOf('.') !== -1) {
              url = 'http://' + url;
            } else {
              url = 'https://google.com/search?q=' + url;
            }
          }

          SOCIALBROWSER.call('update-view', {
            url: url,
          });

          $scope.url = '';
        };

        $scope.loadUrls();
      });
    </script>
  </body>
</html>
