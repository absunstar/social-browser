<!DOCTYPE html>
<html lang="en" ng-app="myApp">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Address-Bar</title>

    <link rel="stylesheet" href="http://127.0.0.1:60080/css/layout.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/modal.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/form.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/color.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/effect.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/table.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/theme.css">
    <link rel="stylesheet" href="http://127.0.0.1:60080/css/address-bar.css">
</head>

<body ng-controller="mainController">

    <div class="address-input">
        <input id="addressbar_id"  ng-keydown="addressbarKeydown($event)" ng-model="url" ng-change="loadUrls()" ng-click="loadUrls()" type="text">
    </div>

    <div class="url-list ">
        <ul>
            <li ng-click="goUrl(u.url);$event.stopPropagation()" ng-class="{'selected' : u.selected}" href="{{u.url}}"
                ng-repeat="u in url_list">
                <a ng-click="goUrl(u.url);$event.stopPropagation()">
                    <img ng-src="{{u.logo}}" onerror="this.src='http://127.0.0.1:60080/images/no.png'">
                    <span class="bold green" ng-click="goUrl(u.url);$event.stopPropagation()"> ( {{u.count}} ) </span>
                    <span class="blue" ng-click="goUrl(u.url);$event.stopPropagation()"> {{u.url | limitTo:70}} </span>

                    <b class="black" ng-click="goUrl(u.url);$event.stopPropagation()"> {{u.title | limitTo:70}} </b>
                </a>


            </li>
        </ul>
        <div class="row" ng-show="url_list.length > 0">
            <span class="btn bg-blue white bold" onclick="event.preventDefault();event.stopPropagation();" ng-click="urls_sort_property = 'last_visit' ; loadUrls()">
                Sort by Last Visit </span>
            <span class="btn bg-blue white bold" onclick="event.preventDefault();event.stopPropagation();" ng-click="urls_sort_property = 'url'; loadUrls()">
                Sort by URL </span>
            <span class="btn bg-blue white bold" onclick="event.preventDefault();event.stopPropagation();" ng-click="urls_sort_property = 'count'; loadUrls()">
                Sort by Visit Count </span>
        </div>
    </div>




    <script src="http://127.0.0.1:60080/js/an.min.js"></script>

    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>

    <script src="http://127.0.0.1:60080/js/client.js"></script>
    <script src="http://127.0.0.1:60080/js/jquery.js"></script>

    <script>
        if (window.module) module = window.module;
    </script>

    <script>
        window.loadurl = function(url){
            $('#addressbar_id').val(url)
            $('#addressbar_id').select()
            $('#addressbar_id').click()
            $('#addressbar_id').focus()
        }

        var browser = browser || require('ibrowser')({is_render : true})

        var app = angular.module('myApp', []);

        app.controller('mainController', ($scope, $http, $timeout) => {


            $scope.urls_sort_property = '-count';

            $scope.loadUrls = function (all) {

                var data = {
                    url:  $('#addressbar_id').val(),
                    sort: $scope.urls_sort_property
                }

                if (all) {
                    data.url = '';
                }

                $timeout(() => {
                    $http({
                        method: 'POST',
                        url: 'http://127.0.0.1:60080/api/get_urls',
                        data: data
                    }).then(function (response) {
                        $scope.url_index = -1;
                        $scope.url_list = response.data.result;
                        if ($scope.url_list.length > 0) {
                            $scope.show_urls = true;
                            $('.url-list ul').scrollTop(0);
                        } else {
                            $scope.show_urls = false;
                        }
                    })
                }, 100)

            }

            $scope.url_index = -1;

            $scope.clearUrlSelection = function () {
                $scope.url_list.forEach(u => {
                    u.selected = false;
                })
            }

            $scope.selectUrl = function (index) {
                $scope.clearUrlSelection();
                if ($scope.url_list.length > index) {
                    $scope.url_list[index].selected = true;
                    $scope.url = $scope.url_list[index].url;
                    $('.url-list ul').scrollTop($('.url-list ul li')[index].offsetTop - $('.url-list ul').height() +
                        100);
                }
            }

            $scope.addressbarKeydown = function (e) {
                if (e.which === 13) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (e.ctrlKey === true) {
                        $scope.url = $scope.url + '.com';
                        $scope.goUrl($scope.url);
                    } else {
                        $scope.goUrl($scope.url);
                    }
                    $scope.show_urls = false;
                } else if (e.which == 40 /*down*/ ) {
                    e.preventDefault();
                    e.stopPropagation();
                    $scope.url_index++;
                    if ($scope.url_list.length <= $scope.url_index) {
                        $scope.url_index = 0;
                    }
                    $scope.selectUrl($scope.url_index);


                } else if (e.which == 38 /*up*/ ) {
                    e.preventDefault();
                    e.stopPropagation();
                    $scope.url_index--;
                    if ($scope.url_index < 0) {
                        $scope.url_index = $scope.url_list.length - 1
                    }
                    $scope.selectUrl($scope.url_index);

                }
            }

            $scope.bodyKeydown = function (e) {
                $scope.show_urls = false;
            }

            $scope.hi = function () {
                alert('hi');
            }

            $scope.goUrl = function (url) {

                url = url || $scope.url || '';
                if (url.indexOf("://") === -1) {
                    if (url.indexOf(".") !== -1) {
                        url = "http://" + url;
                    } else {
                        url = "https://google.com/search?q=" + url;
                    }
                }

                $scope.url = url;

                browser.sendToMain('update-view', {
                    url: $scope.url
                });

            }


        })
    </script>
</body>

</html>